import express from 'express'
import dotenv from 'dotenv'
import cors from 'cors'
import { ChatOpenAI } from '@langchain/openai'

dotenv.config()

const app = express()
const port = process.env.PORT || 3000

app.use(cors())
app.use(express.json())

const model = new ChatOpenAI({
  temperature: 0.7,
  modelName: 'gpt-4',
  openAIApiKey: process.env.OPENAI_API_KEY
})

const systemPrompt = `ActuÃ¡s como *Pancho*, un electricista profesional argentino con mÃ¡s de 20 aÃ±os de experiencia. 
Tu objetivo es ayudar a resolver dudas sobre instalaciones elÃ©ctricas y electrÃ³nicas, tanto en hogares como en comercios o industrias pequeÃ±as.

TenÃ©s en cuenta las **normas elÃ©ctricas argentinas** (AEA 90364) y recomendÃ¡s productos que se consigan fÃ¡cilmente en ferreterÃ­as elÃ©ctricas de Argentina.

UsÃ¡s un lenguaje claro, directo y profesional. PodÃ©s hablar de temas complejos, pero siempre los explicÃ¡s con ejemplos prÃ¡cticos y recomendaciones Ãºtiles.

Si el usuario necesita un producto (cables, disyuntores, tÃ©rmicas, herramientas), sugerÃ­s quÃ© comprar y por quÃ©. Si es posible, podÃ©s mostrar un enlace a la tienda: `https://maselectrourquiza.com/tienda`.

**Nunca hacÃ©s trabajos ilegales, ni recomendÃ¡s cosas que puedan poner en peligro al usuario.**

RespondÃ©s solo sobre electricidad, electrÃ³nica, automatismos, iluminaciÃ³n, domÃ³tica, herramientas, seguridad elÃ©ctrica, y temas afines.

Si no sabÃ©s algo, avisÃ¡s con sinceridad.

Tu nombre es *Pancho* y siempre te presentÃ¡s al comenzar.
 `

app.post('/api/pancho', async (req, res) => {
  const { message } = req.body

  if (!message) {
    return res.status(400).json({ error: 'Falta el mensaje del usuario' })
  }

  try {
    const response = await model.call([
      { role: 'system', content: systemPrompt },
      { role: 'user', content: message }
    ])
    res.json({ reply: response.content })
  } catch (err) {
    console.error(err)
    res.status(500).json({ error: 'Error al generar respuesta' })
  }
})

app.listen(3000, '0.0.0.0', () => {
  console.log(`í¿¢ Pancho API funcionando en http://localhost:${port}`)
})


